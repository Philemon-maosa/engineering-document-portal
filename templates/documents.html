{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-file-alt me-2"></i>Documents</h2>
            <p class="text-muted mb-0">Manage and browse all documents</p>
        </div>
        <div class="d-flex gap-2">
            <!-- Tags Management Button -->
            <a href="{{ url_for('tags') if 'tags' in url_for.__globals__ else '#' }}" 
               class="btn btn-info" title="View all tags">
                <i class="fas fa-tags me-2"></i>Tags
            </a>
            {% if session.get('role') in ['admin', 'engineer'] %}
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newDocumentModal">
                <i class="fas fa-plus me-2"></i>New Document
            </button>
            {% endif %}
        </div>
    </div>

    <!-- =========== FILTERS SECTION =========== -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <!-- Search Results Info -->
            {% if search_query %}
            <div class="alert alert-info mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-search me-2"></i>
                        Search results for: <strong>"{{ search_query }}"</strong>
                        <span class="badge bg-primary ms-2">{{ documents|length }} result(s)</span>
                    </div>
                    <a href="{{ url_for('documents') }}" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-times me-1"></i>Clear Search
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Filter Controls -->
            <form method="GET" action="{{ url_for('documents') }}" class="row g-3">
                <!-- Hidden search query field to preserve search when filtering -->
                {% if search_query %}
                <input type="hidden" name="q" value="{{ search_query }}">
                {% endif %}

                <!-- Filter Row -->
                <div class="col-md-3">
                    <label class="form-label">Project</label>
                    <select name="project" class="form-select form-select-sm">
                        <option value="">All Projects</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}" 
                                {% if current_project_filter == project.id|string %}selected{% endif %}>
                            {{ project.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">Author</label>
                    <select name="author" class="form-select form-select-sm">
                        <option value="">All Authors</option>
                        {% for user in users %}
                        <option value="{{ user.id }}"
                                {% if current_author_filter == user.id|string %}selected{% endif %}>
                            {{ user.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label class="form-label">Category</label>
                    <select name="category" class="form-select form-select-sm">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category }}"
                                {% if current_category_filter == category %}selected{% endif %}>
                            {{ category }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select form-select-sm">
                        <option value="">All Status</option>
                        <option value="draft" {% if current_status_filter == 'draft' %}selected{% endif %}>Draft</option>
                        <option value="in_review" {% if current_status_filter == 'in_review' %}selected{% endif %}>In Review</option>
                        <option value="approved" {% if current_status_filter == 'approved' %}selected{% endif %}>Approved</option>
                        <option value="archived" {% if current_status_filter == 'archived' %}selected{% endif %}>Archived</option>
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label class="form-label">Date Range</label>
                    <select name="date" class="form-select form-select-sm">
                        <option value="">All Time</option>
                        <option value="today" {% if current_date_filter == 'today' %}selected{% endif %}>Today</option>
                        <option value="week" {% if current_date_filter == 'week' %}selected{% endif %}>Last 7 Days</option>
                        <option value="month" {% if current_date_filter == 'month' %}selected{% endif %}>Last 30 Days</option>
                        <option value="year" {% if current_date_filter == 'year' %}selected{% endif %}>Last Year</option>
                    </select>
                </div>
                
                <div class="col-md-12 d-flex align-items-end justify-content-end mt-2">
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-filter me-1"></i> Apply Filters
                        </button>
                        <a href="{{ url_for('documents') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-times me-1"></i>Clear All
                        </a>
                    </div>
                </div>
            </form>

            <!-- Active Filters Badges -->
            {% if current_project_filter or current_author_filter or current_category_filter or current_status_filter or current_date_filter %}
            <div class="mt-3">
                <small class="text-muted me-2">Active filters:</small>
                {% if current_project_filter %}
                    {% set project = projects|selectattr('id', 'equalto', current_project_filter|int)|first %}
                    {% if project %}
                    <span class="badge bg-primary me-1">
                        Project: {{ project.name }}
                        <a href="{{ url_for('documents', q=search_query, author=current_author_filter, category=current_category_filter, status=current_status_filter, date=current_date_filter) }}" 
                           class="text-white ms-1" style="text-decoration: none;">×</a>
                    </span>
                    {% endif %}
                {% endif %}
                
                {% if current_author_filter %}
                    {% set author = users|selectattr('id', 'equalto', current_author_filter|int)|first %}
                    {% if author %}
                    <span class="badge bg-info me-1">
                        Author: {{ author.username }}
                        <a href="{{ url_for('documents', q=search_query, project=current_project_filter, category=current_category_filter, status=current_status_filter, date=current_date_filter) }}" 
                           class="text-white ms-1" style="text-decoration: none;">×</a>
                    </span>
                    {% endif %}
                {% endif %}
                
                {% if current_category_filter %}
                    <span class="badge bg-success me-1">
                        Category: {{ current_category_filter }}
                        <a href="{{ url_for('documents', q=search_query, project=current_project_filter, author=current_author_filter, status=current_status_filter, date=current_date_filter) }}" 
                           class="text-white ms-1" style="text-decoration: none;">×</a>
                    </span>
                {% endif %}
                
                {% if current_status_filter %}
                    <span class="badge bg-warning me-1">
                        Status: {{ current_status_filter|replace('_', ' ')|title }}
                        <a href="{{ url_for('documents', q=search_query, project=current_project_filter, author=current_author_filter, category=current_category_filter, date=current_date_filter) }}" 
                           class="text-white ms-1" style="text-decoration: none;">×</a>
                    </span>
                {% endif %}
                
                {% if current_date_filter %}
                    <span class="badge bg-secondary me-1">
                        Date: {{ current_date_filter|replace('_', ' ')|title }}
                        <a href="{{ url_for('documents', q=search_query, project=current_project_filter, author=current_author_filter, category=current_category_filter, status=current_status_filter) }}" 
                           class="text-white ms-1" style="text-decoration: none;">×</a>
                    </span>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    <!-- =========== END FILTERS SECTION =========== -->

    <!-- Statistics Bar -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">Total Documents</h6>
                            <h4 class="mb-0">{{ documents|length }}</h4>
                        </div>
                        <i class="fas fa-file-alt fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">Approved</h6>
                            <h4 class="mb-0">{{ documents|selectattr('status', 'equalto', 'approved')|list|length }}</h4>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">In Review</h6>
                            <h4 class="mb-0">{{ documents|selectattr('status', 'equalto', 'in_review')|list|length }}</h4>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">Drafts</h6>
                            <h4 class="mb-0">{{ documents|selectattr('status', 'equalto', 'draft')|list|length }}</h4>
                        </div>
                        <i class="fas fa-edit fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category=='success' else 'danger' if category == 'danger' else 'warning' }} alert-dismissible fade show" role="alert">
            <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' if category == 'danger' else 'info-circle' }} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Quick Filters (Client-side) -->
    <div class="card shadow-sm mb-4">
        <div class="card-body py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-filter me-2"></i>Quick Category: 
                            <span id="currentCategory">All</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item category-filter" href="#" data-category="">All Categories</a></li>
                            {% for category in categories %}
                            <li><a class="dropdown-item category-filter" href="#" data-category="{{ category }}">{{ category }}</a></li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-flag me-2"></i>Quick Status: 
                            <span id="currentStatus">All</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item status-filter" href="#" data-status="">All Status</a></li>
                            <li><a class="dropdown-item status-filter" href="#" data-status="draft">Draft</a></li>
                            <li><a class="dropdown-item status-filter" href="#" data-status="in_review">In Review</a></li>
                            <li><a class="dropdown-item status-filter" href="#" data-status="approved">Approved</a></li>
                            <li><a class="dropdown-item status-filter" href="#" data-status="archived">Archived</a></li>
                        </ul>
                    </div>
                    <!-- Tag Filter Dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-tag me-2"></i>Quick Tag: 
                            <span id="currentTag">All</span>
                        </button>
                        <ul class="dropdown-menu" style="max-height: 300px; overflow-y: auto;">
                            <li><a class="dropdown-item tag-filter" href="#" data-tag="">All Tags</a></li>
                            {% if tags %}
                                {% for tag in tags %}
                                <li><a class="dropdown-item tag-filter" href="#" data-tag="{{ tag.id }}">
                                    <i class="fas fa-hashtag me-1"></i>{{ tag.name }}
                                    <span class="badge bg-secondary float-end">{{ tag.documents|length }}</span>
                                </a></li>
                                {% endfor %}
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <div>
                    <span class="text-muted" id="documentCount">{{ documents|length }} document{{ 's' if documents|length != 1 }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents Grid -->
    {% if documents %}
    <div class="row" id="documentsGrid">
        {% for doc in documents %}
        <div class="col-md-6 mb-4 document-card" 
             data-category="{{ doc.category|lower }}" 
             data-status="{{ doc.status|lower }}"
             data-tags="{{ doc.tags|map(attribute='id')|join(',') }}">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-secondary">{{ doc.category if doc.category else "General" }}</span>
                        <span class="badge bg-{{ 'warning' if doc.status == 'draft' else 'info' if doc.status == 'in_review' else 'success' if doc.status == 'approved' else 'secondary' }} ms-1">
                            {{ doc.status|replace('_', ' ')|title if doc.status else 'Draft' }}
                        </span>
                    </div>
                    {% set current_version = doc.versions|first if doc.versions else None %}
                    {% if current_version %}
                    <span class="badge bg-dark">
                        v{{ current_version.version_number }}
                    </span>
                    {% endif %}
                </div>
                
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="{{ url_for('document_detail', doc_id=doc.id) }}" class="text-decoration-none">
                            {{ doc.title }}
                        </a>
                    </h5>
                    <p class="card-text text-muted">{{ doc.description|truncate(150) }}</p>
                    
                    <!-- Document Metadata -->
                    <div class="mb-3">
                        <div class="row small text-muted">
                            <div class="col-6">
                                <i class="fas fa-user me-1"></i>
                                {{ doc.author.username if doc.author else "Unknown" }}
                            </div>
                            <div class="col-6">
                                <i class="fas fa-calendar me-1"></i>
                                {{ doc.created_at.strftime('%Y-%m-%d') }}
                            </div>
                        </div>
                        <div class="row small text-muted mt-1">
                            <div class="col-6">
                                <i class="fas fa-folder me-1"></i>
                                {% if doc.project %}
                                <a href="{{ url_for('project_detail', project_id=doc.project.id) }}" class="text-muted">
                                    {{ doc.project.name }}
                                </a>
                                {% else %}
                                No project
                                {% endif %}
                            </div>
                            <div class="col-6">
                                <i class="fas fa-clock me-1"></i>
                                Updated {{ doc.updated_at.strftime('%Y-%m-%d') }}
                            </div>
                        </div>
                    </div>

                    <!-- File Info -->
                    {% if current_version %}
                    <div class="alert alert-light py-2 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-file text-primary me-2"></i>
                                <strong>{{ current_version.filename }}</strong>
                                <div class="small text-muted mt-1">
                                    <span class="me-3">{{ current_version.file_type if current_version.file_type else "Unknown type" }}</span>
                                    {% if current_version.file_size %}
                                    <span>{{ current_version.formatted_size }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <a href="{{ url_for('download_file', filename=current_version.filename) }}" 
                               class="btn btn-sm btn-outline-primary" title="Download">
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Tags -->
                    {% if doc.tags %}
                    <div class="mb-3" id="tags-{{ doc.id }}">
                        {% for tag in doc.tags %}
                        <span class="badge bg-light text-dark me-1 mb-1 tag-badge" 
                              data-tag-id="{{ tag.id }}" 
                              style="cursor: pointer;"
                              onclick="filterByTag({{ tag.id }})"
                              title="Click to filter by this tag">
                            <i class="fas fa-hashtag"></i> {{ tag.name }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Actions -->
                    <div class="d-flex justify-content-between">
                        <div class="btn-group">
                            <a href="{{ url_for('document_detail', doc_id=doc.id) }}" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-eye me-1"></i>View
                            </a>
                            {% if session.get("role") in ["admin", "engineer"] %}
                            <a href="{{ url_for('edit_document', doc_id=doc.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-edit me-1"></i>Edit
                            </a>
                            {% endif %}
                        </div>
                        {% if session.get("role") == "admin" %}
                        <form action="{{ url_for('delete_document', doc_id=doc.id) }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('Delete this document and all its versions?')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Version History Link -->
                <div class="card-footer bg-transparent border-top-0 text-end">
                    <a href="{{ url_for('document_versions', doc_id=doc.id) }}" class="small text-decoration-none">
                        <i class="fas fa-history me-1"></i>
                        {% if doc.versions|length > 1 %}
                        {{ doc.versions|length }} versions
                        {% else %}
                        Version history
                        {% endif %}
                    </a>
                    <!-- Comments Count -->
                    {% if doc.comments %}
                    <span class="small ms-3">
                        <i class="fas fa-comments me-1"></i>{{ doc.comments|length }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        {% if search_query or current_project_filter or current_author_filter or current_category_filter or current_status_filter or current_date_filter %}
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h4>No documents found</h4>
            <p class="text-muted mb-4">Try adjusting your search criteria or filters</p>
            <a href="{{ url_for('documents') }}" class="btn btn-primary">
                <i class="fas fa-times me-1"></i>Clear all filters
            </a>
        {% else %}
            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
            <h4>No documents found</h4>
            <p class="text-muted mb-4">Get started by creating your first document</p>
            {% if session.get('role') in ['admin', 'engineer'] %}
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newDocumentModal">
                <i class="fas fa-plus me-2"></i>Create First Document
            </button>
            {% endif %}
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- New Document Modal -->
<div class="modal fade" id="newDocumentModal" tabindex="-1" aria-labelledby="newDocumentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="POST" action="{{ url_for('documents') }}" enctype="multipart/form-data" class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="newDocumentModalLabel">
            <i class="fas fa-plus-circle me-2"></i>Create New Document
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Title <span class="text-danger">*</span></label>
                    <input type="text" name="title" class="form-control" placeholder="Enter document title" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Category</label>
                    <select name="category" class="form-select">
                        {% for category in categories %}
                        <option value="{{ category }}" {% if category == 'General' %}selected{% endif %}>
                            {{ category }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Description <span class="text-danger">*</span></label>
            <textarea name="description" class="form-control" rows="3" placeholder="Describe the document content..." required></textarea>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Assign to Project (optional)</label>
                    <select name="project_id" class="form-select">
                        <option value="">-- No Project --</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Initial Status</label>
                    <select name="status" class="form-select">
                        <option value="draft" selected>Draft</option>
                        <option value="in_review">In Review</option>
                        <option value="approved">Approved</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Tags Section for New Document -->
        <div class="mb-4">
            <h6><i class="fas fa-tags me-2"></i>Tags</h6>
            <div class="mb-3">
                <label class="form-label">Select Existing Tags</label>
                <select name="selected_tags" class="form-select" multiple size="4" id="tagSelect">
                    {% if tags %}
                        {% for tag in tags %}
                            <option value="{{ tag.id }}">{{ tag.name }}</option>
                        {% endfor %}
                    {% else %}
                        <option disabled>No tags available. Create new tags below.</option>
                    {% endif %}
                </select>
                <div class="form-text">
                    Hold Ctrl (Cmd on Mac) to select multiple tags
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Add New Tags</label>
                <div class="input-group">
                    <input type="text" id="newTagInput" class="form-control" placeholder="Enter new tags, comma-separated">
                    <button type="button" class="btn btn-outline-secondary" id="addTagsBtn">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                <div class="form-text">
                    Example: "api, documentation, backend"
                </div>
            </div>
            
            <!-- Selected Tags Display -->
            <div class="mt-2" id="selectedTags">
                <!-- Tags will be added here dynamically -->
            </div>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Upload File (optional)</label>
            <input type="file" name="file" class="form-control" id="newDocumentFile">
            <div class="form-text">
                All file types supported (PDF, Word, Excel, Images, etc.). Max 50MB.
                Documents can be created without files and uploaded later.
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">
            <i class="fas fa-check me-2"></i>Create Document
        </button>
      </div>
    </form>
  </div>
</div>

<style>
.card {
    border: 1px solid rgba(0,0,0,0.125);
    transition: transform 0.2s;
}
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.badge {
    font-size: 0.75em;
}
.document-card {
    animation: fadeIn 0.3s ease-in;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.tag-badge:hover {
    background-color: #e9ecef !important;
    transform: scale(1.05);
}
#selectedTags .badge {
    font-size: 0.9em;
    padding: 0.5em 0.75em;
    margin: 0.2em;
}
.filter-badge {
    cursor: pointer;
}
.filter-badge:hover {
    opacity: 0.8;
}
</style>

<script>
// Filter documents by category, status, and tag (client-side filtering for quick filters)
document.addEventListener('DOMContentLoaded', function() {
    // Category filter
    document.querySelectorAll('.category-filter').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const category = this.getAttribute('data-category');
            document.getElementById('currentCategory').textContent = category || 'All';
            filterDocuments();
        });
    });
    
    // Status filter
    document.querySelectorAll('.status-filter').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const status = this.getAttribute('data-status');
            document.getElementById('currentStatus').textContent = status || 'All';
            filterDocuments();
        });
    });
    
    // Tag filter
    document.querySelectorAll('.tag-filter').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const tagId = this.getAttribute('data-tag');
            const tagName = tagId ? this.textContent.trim() : 'All';
            document.getElementById('currentTag').textContent = tagId ? tagName.replace(/\s+\d+$/, '') : 'All';
            filterDocuments();
        });
    });
    
    function filterDocuments() {
        const selectedCategory = document.getElementById('currentCategory').textContent.toLowerCase();
        const selectedStatus = document.getElementById('currentStatus').textContent.toLowerCase();
        const selectedTag = document.getElementById('currentTag').textContent;
        const cards = document.querySelectorAll('.document-card');
        let visibleCount = 0;
        
        cards.forEach(card => {
            const cardCategory = card.getAttribute('data-category');
            const cardStatus = card.getAttribute('data-status');
            const cardTags = card.getAttribute('data-tags').split(',').filter(id => id);
            
            const categoryMatch = !selectedCategory || selectedCategory === 'all' || 
                                 cardCategory === selectedCategory.toLowerCase();
            const statusMatch = !selectedStatus || selectedStatus === 'all' || 
                               cardStatus === selectedStatus.toLowerCase();
            const tagMatch = !selectedTag || selectedTag === 'All' || 
                            cardTags.includes(selectedTag.split(' - ')[0]);
            
            if (categoryMatch && statusMatch && tagMatch) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Update count
        document.getElementById('documentCount').textContent = 
            `${visibleCount} document${visibleCount !== 1 ? 's' : ''}`;
    }
    
    // Tag filtering from document tags
    window.filterByTag = function(tagId) {
        const tagElement = document.querySelector(`.tag-filter[data-tag="${tagId}"]`);
        if (tagElement) {
            tagElement.click();
        }
    };
    
    // File size validation for new document
    const fileInput = document.getElementById('newDocumentFile');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const maxSize = 50 * 1024 * 1024; // 50MB
            
            if (file && file.size > maxSize) {
                alert('❌ File size exceeds 50MB limit. Please choose a smaller file.');
                e.target.value = '';
            }
        });
    }
    
    // ===== TAG MANAGEMENT FOR NEW DOCUMENTS =====
    const newTagInput = document.getElementById('newTagInput');
    const addTagsBtn = document.getElementById('addTagsBtn');
    const selectedTagsContainer = document.getElementById('selectedTags');
    const tagSelect = document.getElementById('tagSelect');
    
    if (addTagsBtn && newTagInput && selectedTagsContainer) {
        let selectedTagIds = new Set();
        
        // Add new tags button
        addTagsBtn.addEventListener('click', function() {
            const tagText = newTagInput.value.trim();
            if (!tagText) return;
            
            const tags = tagText.split(',').map(tag => tag.trim()).filter(tag => tag);
            
            tags.forEach(tagName => {
                // Check if this is a new tag (not in existing select)
                const existingOption = Array.from(tagSelect.options).find(opt => 
                    opt.text.toLowerCase() === tagName.toLowerCase()
                );
                
                if (existingOption) {
                    // Tag exists in database
                    if (!selectedTagIds.has(existingOption.value)) {
                        existingOption.selected = true;
                        selectedTagIds.add(existingOption.value);
                        addTagBadge(tagName, existingOption.value, false);
                    }
                } else {
                    // New tag - we'll handle this server-side
                    addTagBadge(tagName, '', true);
                }
            });
            
            newTagInput.value = '';
        });
        
        // Allow Enter key to add tags
        newTagInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTagsBtn.click();
            }
        });
        
        // Handle selections from dropdown
        if (tagSelect) {
            tagSelect.addEventListener('change', function() {
                Array.from(this.selectedOptions).forEach(option => {
                    if (!selectedTagIds.has(option.value)) {
                        selectedTagIds.add(option.value);
                        addTagBadge(option.text, option.value, false);
                    }
                });
            });
        }
        
        function addTagBadge(tagName, tagId, isNew) {
            const badge = document.createElement('span');
            badge.className = 'badge bg-light text-dark me-1 mb-1';
            
            if (isNew) {
                badge.innerHTML = `
                    ${tagName}
                    <input type="hidden" name="new_tags" value="${tagName}">
                    <button type="button" class="btn-close btn-close-sm ms-1" onclick="removeTag(this)"></button>
                `;
            } else {
                badge.innerHTML = `
                    ${tagName}
                    <input type="hidden" name="selected_tags" value="${tagId}">
                    <button type="button" class="btn-close btn-close-sm ms-1" onclick="removeTag(this)"></button>
                `;
            }
            
            selectedTagsContainer.appendChild(badge);
        }
    }
});

// Global function to remove tags
function removeTag(button) {
    const badge = button.parentElement;
    const tagId = badge.querySelector('input[name="selected_tags"]')?.value;
    
    // If it was a selected tag from dropdown, deselect it
    if (tagId) {
        const select = document.getElementById('tagSelect');
        if (select) {
            const option = Array.from(select.options).find(opt => opt.value === tagId);
            if (option) option.selected = false;
        }
    }
    
    badge.remove();
}
</script>
{% endblock %}